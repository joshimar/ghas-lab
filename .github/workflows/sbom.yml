name: Build + SBOMs
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # Build bytes so hashing works
      - name: Build (package)
        run: mvn -B -DskipTests clean package

      # Component/JAR-level hashes (inside bom.json/xml -> components[].hashes[])
      - name: Generate CycloneDX SBOM
        run: mvn -B org.cyclonedx:cyclonedx-maven-plugin:makeBom

      # ----- per-file digests start here -----

      # Copy the exact deps your app resolved (runtime scope)
      - name: Copy resolved dependencies
        run: mvn -B dependency:copy-dependencies -DincludeScope=runtime -DoutputDirectory=target/deps

      # Explode your app JAR (so inner files can be hashed)
      - name: Explode app JAR
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/app-exploded
          # explode only your primary JAR(s)
          for j in target/*.jar; do
            [ -f "$j" ] && unzip -qq -o "$j" -d target/app-expl
