name: Build + SBOMs
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Ensure tools
        run: sudo apt-get update && sudo apt-get install -y unzip jq

      # 1) Build JAR so bytes exist to hash
      - name: Build (package)
        run: mvn -B -DskipTests clean package

      # 2) CycloneDX SBOM (component/JAR-level hashes in bom.json/xml)
      - name: Generate CycloneDX SBOM
        run: mvn -B org.cyclonedx:cyclonedx-maven-plugin:makeBom

      # ----- per-file digests start here -----

      # 3) Copy the exact deps your app resolved (runtime scope)
      - name: Copy resolved dependencies
        run: mvn -B dependency:copy-dependencies -DincludeScope=runtime -DoutputDirectory=target/deps

      # 4) Explode your app JAR(s) so inner files can be hashed
      - name: Explode app JAR(s)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/app-exploded
          shopt -s nullglob
          jars=(target/*.jar)
          if (( ${#jars[@]} )); then
            for j in "${jars[@]}"; do
              unzip -qq -o "$j" -d target/app-exploded
            done
          else
            echo "No app JARs found under target/"
          fi

      # 5) Explode every dependency JAR into its own folder
      - name: Explode dependency JARs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/deps-exploded
          if [ -d target/deps ]; then
            find target/deps -type f -name '*.jar' -print0 | while IFS= read -r -d '' j; do
              base="$(basename "$j" .jar)"
              d="target/deps-exploded/$base"
              mkdir -p "$d"
              unzip -qq -o "$j" -d "$d"
            done
          else
            echo "No target/deps directory found (did dependency:copy-dependencies run?)"
          fi

      # 6) Create an SPDX with checksums for EACH inner file (exploded dirs)
      - name: Per-file SPDX (exploded deps + app)
        uses: anchore/sbom-action@v0
        env:
          # include ALL files, not just “owned-by-package” (the default)
          SYFT_FILE_METADATA_SELECTION: all
